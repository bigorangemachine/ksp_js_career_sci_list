<!DOCTYPE html>
<html lang="en">
<head>
<meta charset=utf-8>
<title>Kerbal Upload</title>

<style type="text/css">
#no-js-msg,
#status {
	padding: 5px;
	color: #fff;
	background: #ccc;
}
#no-js-msg{display:block;}
body.hasJS #status {display:block;}
body.hasJS #status.fail {background: #c00;}
body.hasJS #status.success {background: #0c0;}
body.hasJS #status.offline {background: #c00;}
body.hasJS #status.online {background: #0c0;}
#holder { border: 10px dashed #ccc; width: 300px; height: 300px; margin: 20px auto;}
#holder.hover { border: 10px dashed #333; }
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="js/js.js"></script>
<script src="js/fps.requestAnimate.js"></script>
<script src="js/ksp.parser.js"></script>
<body>


<div id="holder"></div> 
<noscript type="text/html"><p id="no-js-msg">JavaScript is Required</p></noscript>
<p id="status">Please use the latest Chrome or Firefox Browser.</p>
<p>Drag your KSP Save Game</p>

<script type="text/javascript">
	document.body.className=document.body.className+' hasJS';
	var loading_stages={
			'error':'Something seems to have gone wrong',
			'ready':'Awaiting ID',
			'have_file':'Oh, Hello Jeb!',
			'searching_file':'It seems that we have lost your file.  How about you get yourself some snacks while we find it...',
			'searching_science':'Don\'t mind the radioactive goo; it always does that when there is someone new.',
			'reviewing_science':'Let\'s see if we can make sense of this K-EB-A2',
			'count_off_science':' Scientific Mission',
			'sorting_data':'Boss Kerman is going to fire someone. This data is a mess... '
		},
		page_data={
			'parsed_science':[],
			'scenarios':{},
			'scenarios_attribs':{},
			'sciences':{},
			'sciences_attribs':{}
		},
		kspUniObj=new kspUniverse(),
		kspSciObj=new kspSci(kspUniObj),
		kspObj=new kspParser(kspUniObj,kspSciObj),
		FPSObj=new fpsHandler(5),
		current_state_key='ready',
		drag_target = $('#holder'),
		msg_obj = $('#status');

//console.log(kspObj.attr_reader("\r\n\t\t\tid = crewReport@KerbinSrfLandedLaunchPad\r\n\t\t\ttitle = Crew Report from LaunchPad\r\n\t\t\tdsc = 1\r\n\t\t\tscv = 0\r\n\t\t\tsbv = 0.3\r\n\t\t\tsci = 1.5\r\n\t\t\tcap = 1.5",true));
		
	function update_status_msg(keyIn,extraStr){
		if(bdcheck_key(loading_stages,keyIn)){
			var prefix=(bdcheck_key(extraStr,'pre')?extraStr.pre:''),
				suffix=(bdcheck_key(extraStr,'end')?extraStr.end:'');
			$(msg_obj).html(prefix+loading_stages[keyIn]+suffix);
			if(keyIn=='error'){$(msg_obj).removeClass('success').addClass('fail');}
			else if($(msg_obj).hasClass('fail')){$(msg_obj).addClass('success').removeClass('fail');}
			current_state_key=keyIn;
		}
	}

	function on_captured_science(dataSetIn){
		update_status_msg('sorting_data');
		//str_rep('-',4);
		for(var s=0;s<page_data.parsed_science.length;s++){
			page_data.parsed_science[s].raw_id;
			var parsed_attr=kspObj.parse_sci_id(page_data.parsed_science[s].raw_id);
			page_data.parsed_science[s]={
				'raw_id':page_data.parsed_science[s].raw_id,
				'percent':parsed_attr.percent,
				'planet':parsed_attr.planet,
				'biome':parsed_attr.biome,
				'experiment':parsed_attr.experiment,
				'location':parsed_attr.location
			};
		}
	}
	function read_scenario_chunks(strIn){
		var scenario_inc=0,
			use_data_set=false;
		page_data.scenarios=kspObj.chunk_reader(strIn,'SCENARIO');
		if(page_data.scenarios.length==0){//error handling
			update_status_msg('error');
			return;}
//console.log('page_data.scenarios',page_data.scenarios);
		FPSObj.add_once_callback(function(){
			update_status_msg('searching_science');
			var scenario_iter=function(){
				if(use_data_set!==false){FPSObj.remove_callback(scenario_iter);return;}//probably not needed
				FPSObj.remove_callback(scenario_iter);//stop from stacking
				kspObj.plugin.attr_reader_line=function(packObj){
					if(packObj.clean_key=='name' && packObj.clean_val=='ResearchAndDevelopment'){
						packObj.do_break=true;}
				};
				page_data.scenarios_attribs=kspObj.attr_reader(page_data.scenarios[scenario_inc].clean_chunk);
				kspObj.plugin.attr_reader_line=false;//unset
				
				if(page_data.scenarios_attribs.length>0){
//console.log('-'+scenario_inc,'page_data.scenarios_attribs',$.extend(true,{},page_data.scenarios_attribs));
					for(var a=0;a<page_data.scenarios_attribs.length;a++){
						if(page_data.scenarios_attribs[a].key=='name' && page_data.scenarios_attribs[a].val=='ResearchAndDevelopment'){
							use_data_set=page_data.scenarios[scenario_inc];}
					}
				}
				FPSObj.add_callback(scenario_iter);//stop from stacking
				if(scenario_inc>=(page_data.scenarios.length-1) || use_data_set!==false){
					FPSObj.remove_callback(scenario_iter);
					FPSObj.add_once_callback(function(){
						if(use_data_set!==false){
							on_chunk_found(use_data_set);
						}else{
							try{console.log(page_data.scenarios_attribs, page_data.scenarios);}catch(e){}
						}
						page_data.scenarios=false;
						page_data.scenarios_attribs=false;
						return;
					});
				}
				scenario_inc++;
			};
			setTimeout(function(){
				FPSObj.add_callback(scenario_iter);
			},2500);
		});
	}
	function on_chunk_found(dataSetIn){
		var sci_inc=0,
			sci_total=0;

		FPSObj.change_fps(20);//lets speed it up!
		update_status_msg('reviewing_science');
		var chunk_tick=function(){
			FPSObj.remove_callback(chunk_tick);//stop from stacking
//console.log('chunk -=- tick',sci_inc+' of '+page_data.sciences.length);
			var t_obj={},
				_attribs=kspObj.attr_reader(page_data.sciences[sci_inc].clean_chunk,t_obj);
//console.log('-_attribs',_attribs,'t_obj',t_obj,'floatval('+typeof(t_obj.sci)+' '+t_obj.sci+')',parseFloat(t_obj.sci));
			sci_total=sci_total+parseFloat(t_obj.sci);
			page_data.parsed_science.push({'raw_id':t_obj.id});

			update_status_msg('count_off_science',{'pre':addCommas(sci_inc+1),'end':(sci_inc+1>1?'s':'')+' for '+addCommas(sci_total.toFixed(2))+' science'});
			if(sci_inc>=(page_data.sciences.length-1)){
				FPSObj.remove_callback(chunk_tick);
				FPSObj.add_once_callback(function(){
					setTimeout(function(){
						FPSObj.change_fps(5);//revert
						on_captured_science(page_data.parsed_science);
					},2500);
				});
				return;
			}
			sci_inc++;
			FPSObj.add_callback(chunk_tick);//stop from stacking
		};

	
	
		page_data.sciences=kspObj.chunk_reader(dataSetIn.chunk,'Science');
//console.log('page_data.sciences',page_data.sciences);
		update_status_msg('count_off_science',{'pre':sci_inc,'end':(sci_inc!=1?'s':'')});
		
		setTimeout(function(){
			FPSObj.add_callback(chunk_tick);
		},2500);
	}

	if(typeof window.FileReader === 'undefined'){
		$(msg_obj).addClass('fail');}
	else{
		update_status_msg('ready');
		$(msg_obj).addClass('success');}
	function dodrop(e){
		this.className = '';
		e.preventDefault();

		if(e.originalEvent){var file = e.originalEvent.dataTransfer.files[0];}//jQuery
		else{var file = e.dataTransfer.files[0];}
		var reader = new FileReader();
		reader.onload = function (event){
			update_status_msg('have_file');

			setTimeout(function(){
				$(drag_target).trigger('dragend');
/*
			var inputstr="asdfasdf"+"\n"+
"	}"+"\n"+
"	SCENARIO"+"\n"+
"	{"+"\n"+
//"		}"+"\n"+
"		Science"+"\n"+
"		{"+"\n"+
"...."+"\n"+
"		}"+"\n"+
"		Science"+"\n"+
"		{"+"\n"+
"			id = evaReport@MinmusInSpaceLowFlats"+"\n"+
"			title = EVA Report from space just above Minmus's Flats"+"\n"+
"			dsc = 1"+"\n"+
"			scv = 0"+"\n"+
"			sbv = 4"+"\n"+
"			sci = 32"+"\n"+
"			cap = 32"+"\n"+
"		}"+"\n"+
"		Science"+"\n"+
"		{"+"\n"+
"			id = asteroidSample@KerbinSrfLandedGrasslands_PotatoRoid610034251"+"\n"+
"			title = Sample from Pet Rock at Kerbin's Grasslands"+"\n"+
"			dsc = 1"+"\n"+
"			scv = 0.1428571"+"\n"+
"			sbv = 1"+"\n"+
"			sci = 60"+"\n"+
"			cap = 70"+"\n"+
"		}"+"\n"+
"	}";*/
				var inputstr=reader.result;
				FPSObj.add_once_callback(function(){
					update_status_msg('searching_file');
					setTimeout(function(){
						read_scenario_chunks(inputstr);
					},2500);
				});
			},2500);
		};
		reader.readAsText(file);
		return false;
	}
	$('body').on('dragover',function () {update_status_msg('ready');});
	$(drag_target).on('dragover',function () { $(this).addClass('hover'); return false; });
	$(drag_target).on('dragend',function () { $(this).removeClass('hover'); return false; });
	$(drag_target).on('drop',dodrop);
</script>
</body>
</html>
